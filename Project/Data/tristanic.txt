issue
KeyError in greedy_modularity_communities() when dQ approaches zero#TITLE_END#<!-- If you have a general question about NetworkX, please use the discussions tab to create a new discussion -->  <!--- Provide a general summary of the issue in the Title above -->   ### Current Behavior <!--- Tell us what happens instead of the expected behavior -->  Calling `algorithms.community.greedy_modularity_communities()` on a weighted graph sometimes fails with a `KeyError`, e.g.:  ```---> 15     clusters = community.greedy_modularity_communities(g, weight='weight', resolution=graph_resolution)      16     residue_clusters = []      17     for i, c in enumerate(clusters):  ~/.local/share/ChimeraX/1.3/site-packages/networkx/algorithms/community/modularity_max.py in greedy_modularity_communities(G, weight, resolution)     209                     else:     210                         # Only update per-row heap --> 211                         dq_heap[row].remove(d_old)     212      213         del dq_dict[i]  ~/.local/share/ChimeraX/1.3/site-packages/networkx/utils/mapped_queue.py in remove(self, elt)     112         # Find and remove element     113         try: --> 114             pos = self.d[elt]     115             del self.d[elt]     116         except KeyError:  KeyError: (-7.32467090554133e-06, 1010, 1016) ```  In each case the failure happens when the first value is very close to zero. Could perhaps be avoided by rounding to some reasonable number of significant figures?  ### Expected Behavior <!--- Tell us what should happen -->  ### Steps to Reproduce <!--- Provide a minimal example that reproduces the bug -->  Using the JSON file from https://alphafold.ebi.ac.uk/files/AF-P06213-F1-predicted_aligned_error_v1.json:  ``` def cluster_into_domains(pae_matrix, distance_cutoff=5, graph_resolution=1):     import networkx as nx     import numpy     g = nx.Graph()     size = pae_matrix.shape[0]     g.add_nodes_from(range(size))     for i in range(size):         for j in range(i, size):             pae = pae_matrix[i,j]             if pae < distance_cutoff:                 g.add_edge(i, j, weight=1/pae)      from networkx.algorithms import community      return community.greedy_modularity_communities(g, weight='weight', resolution=graph_resolution)  import json, numpy with open(filename, 'rt') as f:     data = json.load(f)[0] r1, r2, d = data['residue1'],data['residue2'],data['distance'] size = max(r1) pae = numpy.empty((size,size)) pae.ravel()[:] = d  cluster_into_domains(pae, graph_resolution=3) ```    ### Environment <!--- Please provide details about your local environment --> Python version: 3.9 NetworkX version: 2.6.2   ### Additional context <!--- Add any other context about the problem here, screenshots, etc. --> 
issue
Possible fix for floating point KeyError in greedy_modularity_communities#TITLE_END#As per #4992, the existing implementation of `greedy_modularity_communities()` causes intermittent `KeyError`s due to its using a floating point number `dq` as one element of a dict key. One simple fix is to round `dq` to a reasonable number of significant figures.  <!-- Please run black to format your code. See https://networkx.org/documentation/latest/developer/contribute.html for details. --> 
